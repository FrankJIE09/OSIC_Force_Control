# 擦桌子任务的约束分析

## 当前约束

### 1. 法向平移约束（已有）
- **约束方向**：Z方向平移速度 $v_z$
- **约束矩阵**：$A_1 = [0, 0, 1, 0, 0, 0]$
- **物理意义**：保持工具与表面接触，不允许法向运动

## 擦桌子任务需要的额外约束

### 2. 旋转约束 - 保持工具与表面平行

#### 2.1 绕X轴旋转约束（俯仰角 pitch）
- **约束方向**：绕X轴角速度 $\omega_x$
- **物理意义**：防止工具前端或后端翘起
- **约束矩阵行**：$A_2 = [0, 0, 0, 1, 0, 0]$

#### 2.2 绕Y轴旋转约束（横滚角 roll）
- **约束方向**：绕Y轴角速度 $\omega_y$
- **物理意义**：防止工具左右倾斜
- **约束矩阵行**：$A_3 = [0, 0, 0, 0, 1, 0]$

#### 2.3 绕Z轴旋转（偏航角 yaw）- 可选
- **是否约束**：取决于工具形状
  - **圆形工具**（如圆形抹布）：可以允许，增加灵活性
  - **矩形工具**（如矩形刮板）：应该约束，保持方向一致
- **约束矩阵行**：$A_4 = [0, 0, 0, 0, 0, 1]$

## 完整约束矩阵

### 方案1：最小约束（当前 + 旋转约束）
适用于大多数擦桌子任务：

$$
A = \begin{bmatrix}
0 & 0 & 1 & 0 & 0 & 0 \\  % 法向平移
0 & 0 & 0 & 1 & 0 & 0 \\  % 绕X轴旋转
0 & 0 & 0 & 0 & 1 & 0     % 绕Y轴旋转
\end{bmatrix}
$$

**约束数量**：$k = 3$
**允许自由度**：
- X, Y 平移（切向运动）
- 绕Z轴旋转（偏航角，可选）

### 方案2：完全约束（包括偏航角）
适用于需要固定工具方向的场景：

$$
A = \begin{bmatrix}
0 & 0 & 1 & 0 & 0 & 0 \\  % 法向平移
0 & 0 & 0 & 1 & 0 & 0 \\  % 绕X轴旋转
0 & 0 & 0 & 0 & 1 & 0 \\  % 绕Y轴旋转
0 & 0 & 0 & 0 & 0 & 1     % 绕Z轴旋转
\end{bmatrix}
$$

**约束数量**：$k = 4$
**允许自由度**：
- X, Y 平移（切向运动）

## 约束的物理意义

### 为什么需要旋转约束？

1. **保持接触质量**：
   - 无旋转约束时，工具可能倾斜，导致接触不均匀
   - 旋转约束确保工具平面始终与表面平行

2. **提高擦拭效果**：
   - 平行接触时，压力分布均匀
   - 倾斜时，压力集中在边缘，可能损坏表面

3. **避免工具翻转**：
   - 防止工具意外翻转或脱离表面
   - 提高操作稳定性

## 实现建议

### 修改 `compute_constraint_matrix()` 方法

```python
def compute_constraint_matrix(self, constraint_type='minimal'):
    """
    计算约束矩阵 A(θ)
    
    参数:
        constraint_type: 'minimal' (3约束) 或 'full' (4约束)
    """
    if constraint_type == 'minimal':
        # 方案1：最小约束（法向 + 俯仰 + 横滚）
        A = np.zeros((3, 6))
        A[0, 2] = 1.0  # 法向平移 v_z
        A[1, 3] = 1.0  # 绕X轴旋转 ω_x
        A[2, 4] = 1.0  # 绕Y轴旋转 ω_y
    elif constraint_type == 'full':
        # 方案2：完全约束（包括偏航角）
        A = np.zeros((4, 6))
        A[0, 2] = 1.0  # 法向平移 v_z
        A[1, 3] = 1.0  # 绕X轴旋转 ω_x
        A[2, 4] = 1.0  # 绕Y轴旋转 ω_y
        A[3, 5] = 1.0  # 绕Z轴旋转 ω_z
    else:
        # 当前实现：只有法向约束
        A = np.zeros((1, 6))
        A[0, 2] = 1.0
    
    return A
```

## 约束对控制的影响

### 投影矩阵维度变化

- **当前**：$P \in \mathbb{R}^{6 \times 6}$，运动子空间维度 = 5
- **方案1**：$P \in \mathbb{R}^{6 \times 6}$，运动子空间维度 = 3
- **方案2**：$P \in \mathbb{R}^{6 \times 6}$，运动子空间维度 = 2

### 控制分配

| 约束方案 | 运动控制 | 力控制 |
|---------|---------|--------|
| 当前（1约束） | X, Y, ω_x, ω_y, ω_z | Z方向力 |
| 方案1（3约束） | X, Y, ω_z | Z方向力 + 绕X/Y力矩 |
| 方案2（4约束） | X, Y | Z方向力 + 所有旋转力矩 |

## 推荐方案

对于**擦桌子**任务，推荐使用**方案1（最小约束）**：

1. ✅ 保持工具与表面平行（约束俯仰和横滚）
2. ✅ 允许工具绕Z轴旋转（增加灵活性）
3. ✅ 允许X, Y切向运动（擦拭运动）
4. ✅ 约束数量适中，计算稳定

## 注意事项

1. **约束矩阵的条件数**：
   - 增加约束后，需要检查 $(A\Lambda^{-1}A^T)$ 的条件数
   - 条件数过大时使用伪逆

2. **旋转约束的参考方向**：
   - 当前实现假设工具初始姿态与表面平行
   - 如果工具初始倾斜，需要调整约束方向

3. **动态约束**：
   - 可以考虑根据接触力动态调整约束
   - 例如：接触力小时放松旋转约束

